# 高级设置

## 播放器内核选择

NipaPlay 提供多种播放器内核，各有特点：

### 内核对比

- **Libmpv（推荐）**：
  - ✅ 支持硬件解码，性能优异
  - ✅ 兼容性强，支持各种视频格式和字幕
  - ✅ 解码能力完整（官方 Windows 包已自动集成完整版 libmpv，手动构建可参考下文）
  - 🎯 **最推荐使用**，特别是性能受限的设备

- **MDK**：
  - ✅ 跨平台支持良好
  - ✅ 支持硬件解码（默认优先；若驱动/格式不支持会回落到软件解码）
  - ⚠️ 若硬解不可用或兼容性问题，建议切换 Libmpv

- **Video Player**：
  - ✅ Flutter 官方播放器，稳定性好
  - ⚠️ 功能相对基础，兼容性一般
  - 🔧 作为备选方案使用

### 切换建议

- **首选**：Libmpv（性能和兼容性最佳）
- **问题排查**：如遇播放问题，可尝试切换到其他内核进行对比
- **性能考虑**：低配置设备务必使用 Libmpv 以获得硬件解码支持

## Windows 平台解码器优化

> **重要**：Windows 版本由于上游 media-kit 的限制，默认的 libmpv 库解码器不够完整，可能无法播放某些格式或字幕（如 HDR、10bit、PGS字幕等）。  
> 现在官方 GitHub Actions 构建会自动从 [shinchiro/mpv-winbuild-cmake](https://github.com/shinchiro/mpv-winbuild-cmake) 拉取最新的 `mpv-dev-x86_64-v3` 包（该 Dev 包才包含 `libmpv-2.dll`），并使用 `windows/libmpv-2.dll` 替换原始库，因此直接下载 Release/构建产物即可获得完整版解码能力。  
> 如果你需要固定到特定版本，可在自建流水线中设置 `LIBMPV_DOWNLOAD_URL`（或 `LIBMPV_ASSET_PATTERN`）环境变量覆盖默认下载逻辑。只有在你自行编译或希望替换成其他 libmpv 分支时，才需要按照下方步骤手动操作。

### 解决方案（自编译场景）：手动替换 libmpv 库

社区提供了完整版本的 libmpv 库来解决解码器缺失问题：

#### 📋 兼容性要求

- **V3 版本**：需要 CPU 支持 AVX2 指令集（Intel 4代酷睿及以上，约2013年后）
- **普通版本**：需要 CPU 支持 AVX 指令集（Intel 2代酷睿及以上，约2011年后）
- **不支持 AVX**：无法使用此优化方案

#### 🔧 替换步骤

1. **检查 CPU 兼容性**：
   - 使用 CPU-Z 等工具确认 CPU 指令集支持
   - Intel 4代（Haswell）及以上推荐使用 V3 版本
   - Intel 2-3代可尝试普通版本

2. **下载完整版 libmpv**：
   - 访问 [MPV Windows 构建页面](https://sourceforge.net/projects/mpv-player-windows/files/libmpv/)
   - 下载适合的版本（推荐 V3 版本获得最佳兼容性）

3. **替换库文件**：
   - 关闭 NipaPlay
   - 找到安装目录（通常在 `Program Files` 或 `AppData` 下）
   - 备份原始的 `libmpv-2.dll` 文件
   - 将下载的 `libmpv-2.dll` 替换到安装目录
   - 重新启动 NipaPlay

#### ⚠️ 注意事项

- **CPU 不兼容**：使用不匹配的版本可能导致程序崩溃或无法启动
- **备份原文件**：替换前务必备份原始库文件，以便回滚
- **自承风险**：此为社区解决方案

#### 🎯 预期改善

替换后可解决以下问题：

- H.264/H.265 高级格式播放失败
- HDR10、10bit 视频黑屏
- 部分 AVC 编码无法解码
- 杜比视界等高级格式不支持
- PGS/SUP 字幕无法显示

## 弹幕引擎配置

NipaPlay 支持GPU与CPU渲染的弹幕引擎：
- GPU渲染更高效，不过现阶段还有部分不完善的地方
- CPU渲染更稳定，性能开销较大

## 其他设置选项

### 账号管理

**弹弹play账号**：

- **登录功能**：输入用户名和密码登录弹弹play账号
- **观看同步**：自动同步观看进度到弹弹play服务器
- **社区互动**：
  - 对观看的动画进行评分（1-10分）
  - 在播放时发送弹幕参与讨论
  - 查看个人观看统计
- **账号注册**：支持在应用内注册新的弹弹play账号
- **账号注销**：支持在应用内注销弹弹play账号

**Bangumi同步**：

- **访问令牌配置**：
  1. 访问 [bgm.tv 访问令牌页面](https://next.bgm.tv/demo/access-token)
  2. 创建新的访问令牌（权限选择：read, write）
  3. 在设置中输入令牌完成配置
- **自动同步功能**：
  - 观看记录自动同步到Bangumi收藏
  - 观看进度和评分实时更新
  - 收藏状态管理
- **短评功能**：在动画详情页面可以编写和查看Bangumi短评
- **手动同步**：支持一键同步历史观看记录

### 日志与调试

**开发者选项** 中的日志功能对问题反馈非常重要：

**日志查看方式**：

1. 进入 设置 → 开发者选项 → 终端输出
2. 查看实时日志信息
3. 支持复制日志内容用于问题反馈

**移动端特色功能**：

- **Android/平板**：支持将日志导出为二维码，便于快速分享
- **跨设备传输**：通过二维码可快速将日志信息传输到其他设备

**问题反馈建议**：

- 在 GitHub Issues 中提交问题时
- 附带相关的日志信息
- 包含平台信息和详细的重现步骤
- 有助于开发者快速定位和解决问题

详细的日志获取步骤可参考 [故障排查](troubleshooting.md) 部分。

### 解码与性能优化

- **硬件/软件解码**：根据设备性能选择合适的解码方式
- **缓冲策略**：调整视频缓冲参数以适应网络环境
- **性能模式**：在性能和画质间找到平衡点

### 外观个性化

- **主题选择**：nipaplay/fluentui主题切换
- **壁纸设置**：自定义应用背景
- **透明度调整**：界面透明效果控制
- **毛玻璃效果**：现代化界面视觉效果强度调节

---

**⬅️ 上一篇: [媒体服务器整合](server-integration.md)** | **➡️ 下一篇: [常见问题](faq.md)**
